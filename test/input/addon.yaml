#
# Copyright (c) 2006-2011, Prometheus Research, LLC
# See `LICENSE` for license information, `AUTHORS` for the list of authors.
#

title: HTSQL Extensions
id: addon
tests:

- title: tweak
  tests:
  # Addon description
  - ctl: [ext, tweak]

- title: tweak.autolimit
  tests:
  # Addon description
  - ctl: [ext, tweak.autolimit]

  # Set limit=10000 (default)
  - load: demo
    extensions:
      tweak.autolimit: {}

  - uri: /{2+2}
  - uri: /school

  # Merging consecutive limits.
  - uri: /school.limit(10001)
  - uri: /school.limit(10000)
  - uri: /school.limit(9999)
  - uri: /program.limit(2,3)
  - uri: /program.limit(2,3).sort(title)
  - uri: /program.limit(2,3).school
  - uri: /program.limit(2,3).student

  # Set limit=5
  - load: demo
    extensions:
      tweak.autolimit: { limit: 5 }

  - uri: /{2+2}
  - uri: /school

  # Merging consecutive limits.
  - uri: /school.limit(6)
  - uri: /school.limit(5)
  - uri: /school.limit(4)
  - uri: /program.limit(2,3)
  - uri: /program.limit(2,3).sort(title)
  - uri: /program.limit(2,3).school
  - uri: /program.limit(2,3).student

  # Set limit=null
  - load: demo
    extensions:
      tweak.autolimit: { limit: null }

  - uri: /{2+2}
  - uri: /school

- title: tweak.cors
  tests:
  # Addon description
  - ctl: [ext, tweak.cors]

  # Set origin=* (default)
  - load: demo
    extensions:
      tweak.cors: {}
  - uri: /school

  # Set origin=http://demo.htsql.org
  - load: demo
    extensions:
      tweak.cors: { origin: 'http://demo.htsql.org' }
  - uri: /school

  # Set origin=null
  - load: demo
    extensions:
      tweak.cors: { origin: null }
  - uri: /school

- title: tweak.inet
  ifdef: pgsql
  tests:
  # Addon description
  - ctl: [ext, tweak.inet]

  # Use the `type` database to get `other{inet}`
  - load: type
    extensions:
      tweak.inet: {}

  # Introspection and conversion
  - uri: /other{code, inet+, inet(inet), string(inet), integer(inet)}

  # Conversions
  - uri: /{inet('127.0.0.1')}
  - uri: /{inet(string('127.0.0.1')), inet(2130706433)}
  - uri: /{string(inet('127.0.0.1')), integer(inet('127.0.0.1'))}

  # Invalid literals and conversions
  - uri: /{inet('HTSQL')}
    expect: 400
  - uri: /{inet(string('HTSQL'))}
    expect: 409
  - uri: /{inet(-1)}
    expect: 409

  # Comparison
  - uri: /{inet('192.168.24.1')=inet('192.168.24.1'),
           inet('192.168.24.1')!=inet('192.168.12.10'),
           inet('192.168.24.1')>inet('192.168.12.10')}

  # Arithmetics
  - uri: /{inet('192.168.12.10')+3063,
           inet('192.168.24.1')-3063,
           inet('192.168.24.1')-inet('192.168.12.10')}

